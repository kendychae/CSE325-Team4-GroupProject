@page "/opportunities"
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<h3>Service Opportunities</h3>

<div class="filters mb-3">
    <input @bind="searchTerm" @bind:event="oninput" placeholder="Search title..." class="form-control mb-2" />
    <input @bind="locationFilter" @bind:event="oninput" placeholder="Location..." class="form-control mb-2" />
    <select @bind="categoryFilter" class="form-select mb-2">
        <option value="">All Categories</option>
        @foreach (var cat in categories)
        {
            <option value="@cat">@cat</option>
        }
    </select>

    <label>Start Date (From)</label>
    <input type="date" @bind="startDateFilter" @bind:event="oninput" class="form-control mb-2" />

    <label>Start Date (To)</label>
    <input type="date" @bind="endDateFilter" @bind:event="oninput" class="form-control mb-2" />

    <button @onclick="ClearFilters" class="btn btn-outline-secondary mt-2">Clear Filters</button>
</div>

<p><strong>@FilteredOpportunities.Count()</strong> result(s) found</p>

<div class="row">
    @foreach (var o in FilteredOpportunities)
    {
        <div class="col-12 col-md-6 col-lg-4 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">@o.Title</h5>
                    <p class="card-text">@o.Location - @o.Category</p>
                    <p class="card-text"><small>Start: @o.StartDate.ToString("MMM dd, yyyy")</small></p>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private string searchTerm = "";
    private string locationFilter = "";
    private string categoryFilter = "";
    private DateTime? startDateFilter;
    private DateTime? endDateFilter;

    private List<string> categories = new() { "Environment", "Hunger", "Education", "Animals" };

    private List<ServiceOpportunity> opportunities = new()
    {
        new() { Title="Community Park Cleanup", Location="Phoenix", Category="Environment", StartDate=DateTime.Today.AddDays(3) },
        new() { Title="Food Bank Sorting", Location="Tempe", Category="Hunger", StartDate=DateTime.Today.AddDays(10) },
        new() { Title="Senior Center Tech Help", Location="Mesa", Category="Education", StartDate=DateTime.Today.AddDays(-2) },
        new() { Title="Animal Shelter Support", Location="Phoenix", Category="Animals", StartDate=DateTime.Today.AddDays(20) }
    };

    private IEnumerable<ServiceOpportunity> FilteredOpportunities =>
        opportunities.Where(o =>
            (string.IsNullOrWhiteSpace(searchTerm) || o.Title.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) &&
            (string.IsNullOrWhiteSpace(locationFilter) || o.Location.Contains(locationFilter, StringComparison.OrdinalIgnoreCase)) &&
            (string.IsNullOrWhiteSpace(categoryFilter) || o.Category == categoryFilter) &&
            (!startDateFilter.HasValue || o.StartDate.Date >= startDateFilter.Value.Date) &&
            (!endDateFilter.HasValue || o.StartDate.Date <= endDateFilter.Value.Date)
        );

    private void ClearFilters()
    {
        searchTerm = "";
        locationFilter = "";
        categoryFilter = "";
        startDateFilter = null;
        endDateFilter = null;
    }

    public class ServiceOpportunity
    {
        public string Title { get; set; } = "";
        public string Location { get; set; } = "";
        public string Category { get; set; } = "";
        public DateTime StartDate { get; set; }
    }
}
