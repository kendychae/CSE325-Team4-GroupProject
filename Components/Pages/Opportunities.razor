@page "/opportunities"
@using ServeHub.Services
@using ServeHub.Models
@using Microsoft.AspNetCore.Components
@inject IServiceOpportunityService OpportunityService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Service Opportunities - ServeHub</PageTitle>

<div class="container mt-4">
    <div class="row mb-4 opportunities-header">
        <div class="col-md-8">
            <h1>Service Opportunities</h1>
            <p class="lead">Find and join volunteer opportunities in your community</p>
        </div>
        <div class="col-md-4 text-end">
            <AuthorizeView>
                <Authorized>
                    <a href="/opportunities/create" class="btn btn-primary create-opportunity-btn">
                        <i class="bi bi-plus-circle"></i> Create Opportunity
                    </a>
                </Authorized>
            </AuthorizeView>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-3">
            <input class="form-control" placeholder="Search title or description..." @bind-value="searchTerm"
                   @bind-value:event="oninput" />
        </div>

        <div class="col-md-3">
            <input class="form-control" placeholder="Location" @bind-value="locationFilter"
                   @bind-value:event="oninput" />
        </div>

        <div class="col-md-3">
            <select class="form-select" @bind="categoryFilter">
                <option value="">All Categories</option>
                @foreach (var category in categories)
                {
                    <option value="@category">@category</option>
                }
            </select>
        </div>

        <div class="col-md-3 d-flex">
            <button class="btn btn-outline-secondary w-100" @onclick="ClearFilters">
                Clear Search
            </button>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-3">
            <label class="form-label">Start Date (From)</label>
            <input type="date" class="form-control" @bind="startDateFilter" />
        </div>

        <div class="col-md-3">
            <label class="form-label">Start Date (To)</label>
            <input type="date" class="form-control" @bind="endDateFilter" />
        </div>
    </div>

    <div class="results-count">
        <strong>@FilteredOpportunities.Count()</strong> result(s) found
    </div>





    @if (isLoading)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (opportunities == null || !opportunities.Any())
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No service opportunities available at this time.
        </div>
    }
    else
    {
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            @foreach (var opportunity in FilteredOpportunities)

            {
                <div class="col">
                    <div class="card h-100 shadow-sm opportunity-card">
                        @if (!string.IsNullOrEmpty(opportunity.ImageUrl))
                        {
                            <img src="@opportunity.ImageUrl" class="card-img-top" alt="@opportunity.Title"
                                 style="height: 200px; object-fit: cover;">
                        }
                        else
                        {
                            <div class="card-img-top bg-secondary text-white d-flex align-items-center justify-content-center"
                                 style="height: 200px;">
                                <i class="bi bi-heart-fill" style="font-size: 3rem;"></i>
                            </div>
                        }
                        <div class="card-body">
                            <h5 class="card-title">@opportunity.Title</h5>
                            <p class="card-text">
                                @(opportunity.Description.Length > 100
                                    ? opportunity.Description.Substring(0, 100) + "..."
                                    : opportunity.Description)
                            </p>
                            <div class="mb-2">
                                <i class="bi bi-geo-alt"></i> @opportunity.Location
                            </div>
                            <div class="mb-2">
                                <i class="bi bi-calendar-event"></i> @opportunity.StartDate.ToString("MMM dd, yyyy")
                            </div>
                            <div class="mb-2">
                                <i class="bi bi-people"></i> @opportunity.CurrentVolunteers / @opportunity.MaxVolunteers
                                volunteers
                            </div>
                            @if (!string.IsNullOrEmpty(opportunity.Category))
                            {
                                <span class="badge bg-info">@opportunity.Category</span>
                            }
                        </div>
                        <div class="card-footer">
                            <a href="/opportunities/@opportunity.Id" class="btn btn-primary btn-sm w-100">View Details</a>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<ServiceOpportunity>? opportunities;
    private bool isLoading = true;

    private string searchTerm = string.Empty;
    private string locationFilter = string.Empty;
    private string categoryFilter = string.Empty;
    private DateTime? startDateFilter;
    private DateTime? endDateFilter;

    private List<string> categories = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            isLoading = true;

            opportunities = await OpportunityService.GetActiveOpportunitiesAsync();

            // Get all categories from the loaded opportunities
            categories = opportunities
                .Where(o => !string.IsNullOrWhiteSpace(o.Category))
                .Select(o => o.Category!)
                .Distinct()
                .OrderBy(c => c)
                .ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading opportunities: {ex.Message}");
            opportunities = new List<ServiceOpportunity>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ClearFilters()
    {
        searchTerm = string.Empty;
        locationFilter = string.Empty;
        categoryFilter = string.Empty;
        startDateFilter = null;
        endDateFilter = null;
    }

    private IEnumerable<ServiceOpportunity> FilteredOpportunities =>
          opportunities?
              .Where(o =>
                  (string.IsNullOrWhiteSpace(searchTerm) ||
                      o.Title.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                      o.Description.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) &&
                  (string.IsNullOrWhiteSpace(locationFilter) ||
                      o.Location.Contains(locationFilter, StringComparison.OrdinalIgnoreCase)) &&
                  (string.IsNullOrWhiteSpace(categoryFilter) ||
                      o.Category == categoryFilter) &&
                  (!startDateFilter.HasValue || o.StartDate.Date >= startDateFilter.Value.Date) &&
                  (!endDateFilter.HasValue || o.StartDate.Date <= endDateFilter.Value.Date)
              )
          ?? Enumerable.Empty<ServiceOpportunity>();

}